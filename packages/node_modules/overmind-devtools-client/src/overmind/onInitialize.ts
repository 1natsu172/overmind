import { OnInitialize } from 'overmind'

const onInitialize: OnInitialize = async ({ state, effects }, app) => {
  
  // We cannot use storage here since it depends on connector, which is not open yet since we do not know the host!
  // let port = await effects.storage.get<string>('currentPort')
  // const runtimeHost = await effects.storage.get<string>('runtimeHost')

  let port = "3301"; // TODO: const default port somewhere
  if (window['__OVERMIND_DEVTOOLS_BACKEND_PORT__'])
  {
    port = window['__OVERMIND_DEVTOOLS_BACKEND_PORT__'];
  }

  if (port) {
    state.port = port
  }

  effects.connector.open(state.port)
  
  // if (runtimeHost) {
  //   state.runtimeHost = runtimeHost
  // }

  effects.connector.onMessage(app.actions.onMessage)
  // effects.connector.connect(state.port) // This should no longer be needed. DevtoolBackend does nothing when receing.
}

export default onInitialize
