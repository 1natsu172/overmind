import { createElement } from 'overmind-components'

import { Component } from '../../overmind'
import { OperatorsByPath, Action as TAction } from '../../overmind/types'
import {
  getOperatorId,
  getOperatorsByPath,
  nameToColor,
} from '../../overmind/utils'
import ActionOperator from '../ActionOperator'
import * as styles from './styles'

type Props = {
  action: TAction
  inline?: boolean
}

const Action: Component<Props> = ({ action, inline }, { appState }) => {
  const operatorsByPath = getOperatorsByPath(action)

  function renderOperators(operatorsByPath: OperatorsByPath) {
    return operatorsByPath.map((operatorByPath, index) => {
      const flushReference =
        appState.currentApp.flushByOperatorId[
          getOperatorId(operatorByPath.operator)
        ]
      const flush =
        flushReference && appState.currentApp.flushes[flushReference.flushId]

      return (
        <div
          key={'operatorByPath' + index}
          style={{
            opacity: operatorByPath.operator.isSkipped ? 0.5 : 1,
          }}
        >
          <ActionOperator
            operator={operatorByPath.operator}
            flush={flush}
            value={operatorByPath.value}
          />
          {operatorByPath.operator.isIntercepted ? (
            <div className={styles.breakStyle}>break</div>
          ) : null}
          {operatorByPath.childrenByPath.length
            ? operatorByPath.childrenByPath.map(
                (childOperatorsByPath, index) => (
                  <div
                    key={'childOperatorsByPath' + index}
                    className={styles.operatorChildren}
                  >
                    <div
                      className={styles.path}
                      style={{
                        backgroundColor: nameToColor(
                          childOperatorsByPath[0].path
                        ),
                      }}
                    >
                      {childOperatorsByPath[0].path}
                    </div>
                    <div className={styles.pathOperators}>
                      {renderOperators(childOperatorsByPath)}
                    </div>
                  </div>
                )
              )
            : null}
        </div>
      )
    })
  }

  if (inline) {
    return (
      <self className={styles.innerWrapper}>
        <div className={styles.innerTitle}>{action.actionName}</div>
        <div className={styles.innerContent}>
          {operatorsByPath.map(renderOperators)}
        </div>
      </self>
    )
  }

  return (
    <self className={styles.wrapper}>
      {operatorsByPath.map(renderOperators)}
    </self>
  )
}

export default Action
