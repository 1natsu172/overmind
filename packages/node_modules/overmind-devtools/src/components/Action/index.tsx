import { createElement, FunctionComponent, Fragment } from 'react'
import { useOvermind } from '../../overmind'
import * as styles from './styles'
import ActionOperator from '../ActionOperator'
import { getOperatorId, nameToColor } from '../../overmind/utils'
import { OperatorsByPath } from '../../overmind/types'

const Action: FunctionComponent = () => {
  const { state } = useOvermind()
  const operatorsByPath = state.currentOperatorsByPath

  function renderOperators(operatorsByPath: OperatorsByPath) {
    return operatorsByPath.map((operatorByPath, index) => {
      const flushReference =
        state.currentApp.flushByOperatorId[
          getOperatorId(operatorByPath.operator)
        ]
      const flush =
        flushReference && state.currentApp.flushes[flushReference.flushId]

      return (
        <div
          key={operatorByPath.path + index}
          style={{
            opacity: operatorByPath.operator.isSkipped ? 0.5 : 1,
          }}
        >
          <ActionOperator
            operator={operatorByPath.operator}
            flush={flush}
            value={operatorByPath.value}
          />
          {operatorByPath.operator.isIntercepted ? (
            <div className={styles.breakStyle}>break</div>
          ) : null}
          {operatorByPath.childrenByPath.length
            ? operatorByPath.childrenByPath.map(
                (childOperatorsByPath, index) => (
                  <div key={index} className={styles.operatorChildren}>
                    <div
                      className={styles.path}
                      style={{
                        backgroundColor: nameToColor(
                          childOperatorsByPath[0].path
                        ),
                      }}
                    >
                      {childOperatorsByPath[0].path}
                    </div>
                    <div className={styles.pathOperators}>
                      {renderOperators(childOperatorsByPath)}
                    </div>
                  </div>
                )
              )
            : null}
        </div>
      )
    })
  }

  return (
    <div className={styles.wrapper}>{operatorsByPath.map(renderOperators)}</div>
  )
}

export default Action
