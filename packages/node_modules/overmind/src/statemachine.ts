import { Derive } from './'

export type StatemachineDefinition<States extends string> = {
  initial: States,
  states: {
    [State in States]: Array<States>
  }
}

export type Statemachine<States extends string> = {
  current: States
  reset: () => void
} & {
  [State in States]: <T>(entry?: () => T, exit?: () => void) => T
}

class Machine<States extends string>  {
  current: States
  private _currentExit: (() => void) | undefined
  constructor(definition: StatemachineDefinition<States>) {
    this.current = definition.initial

    Object.keys(definition.states).reduce((aggr, key) => {
      aggr[key] = (entry, exit) => {
        if (definition.states[this.current].includes(key as any)) {
          if (this._currentExit) this._currentExit()
          this._currentExit = exit
          this.current = key as any
          return entry && entry()
        }
      }
  
      return aggr
    }, this)
  }
  reset() {
    if (this._currentExit) {
      this._currentExit()
      this._currentExit = undefined
    }
  }
}

export function statemachine<States extends string>(definition: StatemachineDefinition<States>): Statemachine<States> {
  return new Machine(definition) as any
}
